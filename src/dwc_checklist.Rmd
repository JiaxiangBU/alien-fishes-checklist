---
title: "Darwin Core mapping"
subtitle: "For dataset: Checklist of alien fishes in Flanders, Belgium"
author:
- Lien Reyserhove
- Dimitri Brosens
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    theme: yeti
    df_print: paged
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

This document describes how we map the checklist data to Darwin Core.

## Setup

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Set locale (so we use UTF-8 character encoding):

```{r, eval = F}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r}
library(tidyverse) # For data transformations

# None core tidyverse packages:
library(magrittr)  # For %<>% pipes

# Other packages
library(janitor)   # For cleaning input data
library(readxl)    # To read excel files
library(stringr)   # to perform string operations
library(digest)    # To generate hashes
```

Set file paths (all paths should be relative to this script):
 
```{r}
# Raw files:
raw_data_file = "../data/raw/ExotischeVissenVlaanderen2016.xlsx"

# Processed files:
dwc_taxon_file = "../data/processed/taxon.csv"
```

## Read data

```{r}
# Read the source data:
raw_data <- read_excel(raw_data_file, sheet = "Checklist", na = "NA") 

# Clean the data somewhat: remove empty rows if present
raw_data %<>%
  remove_empty_rows() %>%     # Remove empty rows
  clean_names()               # Have sensible (lowercase) column names
```

We need to integrate the DwC term `taxonID` in each of the generated files (Taxon Core and extensions).
For this reason, it is easier to to generate this  `taxonID` here in our raw file. 

```{r}
# Vectorize the digest function (The digest() function isn't vectorized. So if you pass in a vector, you get one value for the whole vector rather than a digest for each element of the vector):
vdigest <- Vectorize(digest)

# Generate taxonID:
raw_data %<>% mutate (taxonID = paste("alien-fishes:taxon:", vdigest (latin_name, algo="md5"), sep=""))
```

Further processing:

# Add prefix `raw_` to all column names to avoid name clashes with Darwin Core terms:
colnames(raw_data) <- paste0("raw_", colnames(raw_data))

# Save those column names as a vector (makes it easier to remove them all later):
raw_colnames <- colnames(raw_data)
```

Preview data:

```{r}
head(raw_data)
```

## Create taxon core

```{r}
taxon <- raw_data
```

### Pre-processing
### Term mapping
 
Map the source data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml):
 
#### language

```{r}
taxon %<>% mutate(language = "en")
```

#### license

```{r}
taxon %<>% mutate(license = "http://creativecommons.org/publicdomain/zero/1.0/")
```

#### rightsHolder

```{r}
taxon %<>% mutate(rightsHolder = "Research Institute for Nature and Forest (INBO)")

```

#### accessRights

```{r}
taxon %<>% mutate(accessRights = "http://www.inbo.be/en/norms-for-data-use")
```

#### datasetID

```{r}
taxon %<>% mutate(datasetID = "")
```

#### datasetName

```{r}
taxon %<>% mutate(datasetName = "Checklist of alien fishes in Flanders, Belgium")
```

### taxonID

```{r}
taxon %<>% mutate(taxonID = raw_taxonID)
```

#### scientificName

```{r}
taxon %<>% mutate (scientificName = raw_latin_name)
```

#### kingdom

```{r}
taxon %<>% mutate (kingdom = "Animalia")
```

#### taxonRank

```{r}
taxon %<>% mutate (taxonRank = "species")
```

#### nomenclaturalCode

```{r}
taxon %<>% mutate(nomenclaturalCode = "ICZN")
```

### Post-processing

```{r}
# Remove the original columns:
taxon %<>% select(-one_of(raw_colnames))

# Preview data:
head(taxon)

# Save to CSV:
write.csv(taxon, file = dwc_taxon_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

## Create Vernacular names extension

### Pre-processing:
```{r}
vernacular_names <- raw_data
```

### Term mapping
Map the source data to [Vernacular Names](http://rs.gbif.org/extension/gbif/1.0/vernacularname.xml):

#### taxonID
```{r}
vernacular_names %<>% mutate (taxonID = paste("alien-fishes:taxon:", vdigest (raw_latin_name, algo="md5")))

identical(vernacular_names $ taxonID, taxonID)
```


#### vernacularName
#### source	
#### language
#### temporal
#### locationID
#### locality
#### countryCode
#### sex
#### lifeStage
#### isPlural
#### isPreferredName
#### organismPart
#### taxonRemarks
#### datasetID
